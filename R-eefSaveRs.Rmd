---
title: "Coral Reef Health and Organismal Occurrence Analysis Project"
author: "Jonah Kotzen, Elisabeth Laviolette, Lauren Geary, Elizabeth Breitmeyer & Katie Miller"
date: "2023-12-06"
output: html_document
bibliography: BIOL3140.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rgbif)
library(tidyverse)
library(MuMIn)
library(rnoaa)
library(data.table)
library(ggmap)
library(usmap)
library(sf)
library(magick)
library(cowplot)
library(lme4)
library(car)
library(dplyr)
library(purrr)
library(leaflet)
library(ggplot2)
```

## Introduction
[Provide a brief overview of the project, its objectives, and its significance]

## Objectives
- Objective 1: [Detail the primary objective of your project]
- Objective 2: [Detail the secondary objective of your project, if any]

## Methodology
Briefly describe the methodology used in this project, including data sources and analysis techniques.

### Data Sources
- Coral Reef Health Data: [Describe the source and nature of the coral reef health data]
- Fish Occurrence Data: Using the `rgbif` package to access data from GBIF.

### Data Retrieval and Processing
#### Using `rgbif` for Fish Occurrence Data
```{r querying GBIFs API, echo=FALSE, cache = TRUE, eval=FALSE}

# Species list
species <- c("Triaenodon obesus", "Tridacna gigas", "Chaetodon rainfordi", 
             "Abudefduf vaigiensis", "Chlorurus undulatus", "Cephalopholis miniata", 
             "Chlorurus sordidus")

# Time range
year_range <- "2000,2023"

# Create an empty list to store the data
data_list <- list()

# Loop over the species list and retrieve data for each species
for (sp in species) {
  data_list[[sp]] <- occ_search(scientificName = sp, country = "AU", year = year_range, limit = 25000)
}

```

```{r data rds, include=TRUE}
data_list <- readRDS(file = "data_list.rds")

```

```{r combined data, include=TRUE}
# Directly combine all the data frames into one tibble without filtering NULL values
combined_data <- bind_rows(lapply(data_list, `[[`, "data"))

# Count the number of observations for each species
species_counts <- combined_data %>%
  count(species)

# Calculate the minimum and maximum years in combined_data
year_range_check_CD <- combined_data %>%
  group_by(species) %>% 
  summarise(
    min_year = min(year, na.rm = TRUE),
    max_year = max(year, na.rm = TRUE)
  )

# View the resulting tibble
print(year_range_check_CD)

```


```{r coral bleaching data, echo=FALSE, cache = TRUE}
bleachingdata <- read_csv("bleachingdatabase.csv")
head(bleachingdata)

# Calculate the minimum and maximum years in reef_data
year_range_check <- bleachingdata %>%
  summarise(
    min_year = min(YEAR, na.rm = TRUE),
    max_year = max(YEAR, na.rm = TRUE)
  )

# View the resulting tibble
print(year_range_check)
```

```{r modbleach, include=TRUE}
filtered_data <- bleachingdata %>%
  select(LATITUDE, LONGITUDE, YEAR, SEVERITY_CODE, LOCATION) %>%
  filter(complete.cases(.))
```

```{r reef stuff, include=TRUE}

# Define the latitude and longitude boundaries of the Great Barrier Reef
lat_min <- -24   # Southernmost latitude
lat_max <- -11   # Northernmost latitude
long_min <- 142  # Westernmost longitude
long_max <- 154  # Easternmost longitude

# Add the within_reef column
filtered_data <- filtered_data %>%
  mutate(within_reef = LATITUDE >= lat_min & LATITUDE <= lat_max & 
                        LONGITUDE >= long_min & LONGITUDE <= long_max)


# Group by the within_reef column and count the number of TRUE and FALSE values
reef_count <- filtered_data %>%
  group_by(within_reef) %>%
  summarise(count = n())

# The reef_count tibble now contains the count of TRUE and FALSE values in the within_reef column.

reef_data <- filtered_data %>%
  filter(within_reef == TRUE)

```

```{r zone grouping, include=TRUE}
# Determine new latitude boundaries for each zone based on quantiles
zone_boundary_1 <- quantile(reef_data$LATITUDE, probs = 1/3)
zone_boundary_2 <- quantile(reef_data$LATITUDE, probs = 2/3)

# Re-assign the reef_zone column
reef_data <- reef_data %>%
  mutate(reef_zone = case_when(
    LATITUDE <= zone_boundary_1 ~ "A",
    LATITUDE > zone_boundary_1 & LATITUDE <= zone_boundary_2 ~ "B",
    TRUE ~ "C"
  ))

# Check the new distribution
new_zone_counts <- reef_data %>%
  count(reef_zone)



```


```{r visualizing, include=TRUE}
# Create a leaflet map and add tiles
reef_map <- leaflet() %>% 
  addTiles() %>%  # This adds the default OpenStreetMap tiles
  setView(lng = mean(c(142, 154)), lat = mean(c(-24, -10)), zoom = 6)

# Add points to the map
reef_map <- reef_map %>% 
  addCircleMarkers(data = reef_data, 
                   ~LONGITUDE, 
                   ~LATITUDE, 
                   color = ~case_when(reef_zone == "A" ~ "green",
                                      reef_zone == "B" ~ "orange",
                                      reef_zone == "C" ~ "red"),
                   popup = ~paste("Zone:", reef_zone))

# Print the map
reef_map

```

```{r severity, include=TRUE}
library(dplyr)
library(ggplot2)

# Calculate the average SEVERITY_CODE values for each year and each reef_zone
severity_code_by_year_zone <- reef_data %>%
  group_by(YEAR, reef_zone) %>%
  summarise(
    avg_severity = mean(SEVERITY_CODE, na.rm = TRUE),
    .groups = "drop"
  )

# Plotting the average severity codes for each year, separated by reef_zone
ggplot(severity_code_by_year_zone, aes(x = YEAR, y = avg_severity, group = reef_zone, color = reef_zone)) +
  geom_line() +  # Add line to connect the dots
  geom_point() +  # Add points for each data point
  facet_wrap(~ reef_zone, scales = "free_y") +  # Separate graph for each reef_zone
  theme_minimal() +
  labs(title = "Average Severity Codes Over the Years by Reef Zone",
       x = "Year",
       y = "Average Severity Code") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for better readability

```


```{r zoning species, include=TRUE}
# Assuming zone_boundary_1 and zone_boundary_2 are already defined
# and combined_data has decimalLatitude and decimalLongitude columns

# Add the reef_zone column to combined_data
combined_data <- combined_data %>%
  mutate(reef_zone = case_when(
    decimalLatitude <= zone_boundary_1 ~ "A",
    decimalLatitude > zone_boundary_1 & decimalLatitude <= zone_boundary_2 ~ "B",
    decimalLatitude > zone_boundary_2 ~ "C"
  ))

# Now, combined_data contains the new column reef_zone with values A, B, or C

combined_data <- combined_data %>%
  select(species, decimalLatitude, decimalLongitude, year, reef_zone) %>%
  filter(complete.cases(.))


```

```{r count, include=TRUE}
# Count the number of unique species in each reef zone
species_observations_per_zone_year <- combined_data %>%
  filter(!is.na(reef_zone)) %>%
  group_by(reef_zone, species, year) %>%
  summarise(observation_count = n(), .groups = "drop")

```

```{r plots, include=TRUE}
# Plot observation_count vs. year for each species, facetted by species
ggplot(species_observations_per_zone_year, aes(x = year, y = observation_count, group = reef_zone, color = reef_zone)) +
  geom_line() + 
  geom_point() +  # Add points to the lines
  facet_wrap(~ species, scales = "free_y") +  # Facet by species, with free y scales for each plot
  theme_minimal() + 
  labs(title = "Observation Count vs. Year for Each Species by Reef Zone",
       x = "Year",
       y = "Observation Count",
       color = "Reef Zone") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))  # Rotate x-axis labels for better readability

```

```{r plot 2, include=TRUE}
# Plot observation_count vs. year, separated by reef_zone
ggplot(species_observations_per_zone_year, aes(x = year, y = observation_count, color = species)) +
  geom_line(aes(group = species)) + 
  geom_point(aes(shape = species)) +  # Add points to the lines
  facet_grid(. ~ reef_zone) +  # Create a separate graph for each reef zone
  theme_minimal() + 
  labs(title = "Observation Count vs. Year by Reef Zone",
       x = "Year",
       y = "Observation Count",
       color = "Species",
       shape = "Species") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),  # Rotate x-axis labels for better readability
        legend.position = "bottom") +  # Move legend to bottom
  guides(color = guide_legend(override.aes = list(shape = NA)))  # Remove shapes from color legend
```


# Joining Data

```{r joining, eval=TRUE, include=TRUE}


# Pivot the data wider by species
wider_data <- species_observations_per_zone_year %>%
  pivot_wider(
    id_cols = c(reef_zone, year),
    names_from = species,
    values_from = observation_count,
    values_fill = list(observation_count = 0)  # Fill missing observations with 0
  ) %>%
  arrange(year)  # Sort by year in ascending order

# View the resulting wide-format tibble
print(wider_data)



# Assuming YEAR and reef_zone are common in both datasets and properly aligned

#combined_data --> wider_data
#reef_data


# Filter reef_data for years 2000 to 2023
filtered_reef_data <- reef_data %>%
  filter(YEAR >= 2000, YEAR <= 2023)

# Perform the join with wider_data
joined_data <- left_join(wider_data, filtered_reef_data, by = c("year" = "YEAR", "reef_zone"))  %>%  filter(!is.na(SEVERITY_CODE))

# Check the structure of joined_data
print(head(joined_data))

longer_data <- joined_data %>%
  pivot_longer(
    cols = c("Abudefduf vaigiensis", "Cephalopholis miniata", "Chaetodon rainfordi", 
             "Chlorurus sordidus", "Triaenodon obesus", "Tridacna gigas"),
    names_to = "species",
    values_to = "observation_count"
  )


```

# Correlation between Severity Code and Observation Count

## separate model for each species
```{r correlation, include=TRUE}

library(lme4)

unique_species <- unique(longer_data$species)
models <- list()

for (sp in unique_species) {
    species_data <- longer_data[longer_data$species == sp, ]
    models[[sp]] <- lmer(observation_count ~ SEVERITY_CODE + (1 | reef_zone), data = species_data)

    # Print the species name before printing the model summary
    cat("\nModel for Species:", sp, "\n")
    print(summary(models[[sp]]))
}


```

### interpretation

The linear mixed-effects models demonstrate varied relationships between observation_count and SEVERITY_CODE across species, factoring in reef_zone as a random effect. For Abudefduf vaigiensis (SEVERITY_CODE estimate: -0.05199, reef_zone variance: 82.07) and Cephalopholis miniata (SEVERITY_CODE estimate: -0.0571, reef_zone variance: 6.020), there is a slight negative relationship, suggesting minor reductions in observation counts with increasing severity codes. More pronounced effects are seen in Chaetodon rainfordi (SEVERITY_CODE estimate: -2.7551, reef_zone variance: 355.7) and Chlorurus sordidus (SEVERITY_CODE estimate: -7.030, reef_zone variance: 1251), with the latter showing a substantial decrease in observation counts correlating with higher severity codes, indicating significant ecological impacts.

Conversely, Triaenodon obesus exhibits a very minimal negative effect (SEVERITY_CODE estimate: -0.005411) with a singular fit in the model, suggesting potential model fitting issues or lack of data variation. Tridacna gigas shows a moderate negative relationship (SEVERITY_CODE estimate: -0.07546) with relatively low variability across reef zones (reef_zone variance: 0.008205). These species-specific findings highlight the complexity of ecological dynamics within coral reef ecosystems. The variability in response to environmental severity underscores the need for nuanced, species-specific analyses in marine biodiversity studies, considering the distinct ecological roles and sensitivities of different species within reef environments.


## Including species as a Fixed Effect
```{r species fixed, include=TRUE}
model <- lmer(observation_count ~ SEVERITY_CODE + species + (1 | reef_zone), data = longer_data)

summary(model)


````

### interpretation
The model, represented by the formula observation_count ~ SEVERITY_CODE + species + (1 | reef_zone), demonstrates a significant overall negative relationship between severity codes and observation counts, as indicated by the SEVERITY_CODE coefficient of -1.6958. This suggests that an increase in severity code, indicative of more severe environmental conditions, generally leads to a decrease in observation counts across all species. The model's intercept is set at 8.1568, serving as a baseline for observation counts when other variables are held constant.

Species-specific variations are evident in the model, with certain species showing distinct deviations from the baseline observation counts. For example, speciesChaetodon rainfordi exhibits a substantial increase in observation counts (coefficient: 28.6941), indicating a higher number of observations compared to other species under similar environmental conditions. In contrast, speciesCephalopholis miniata shows a negative deviation from the baseline (coefficient: -4.1461), suggesting fewer observations. The random effects for reef_zone reveal a variance of 107.9, pointing to significant differences in observation counts across various reef zones, which highlights the spatial heterogeneity within reef ecosystems. These findings underscore the complex and nuanced responses of different marine species to varying environmental conditions, emphasizing the need for species-specific conservation and management strategies in coral reef ecosystems.

# Visualization

## Effect of Severity Code on Observation Count for Each Species:

```{r vis, include=TRUE}
library(ggplot2)
library(lme4)
library(dplyr)

# Fit the model (if not already done)
model <- lmer(observation_count ~ SEVERITY_CODE + species + (1 | reef_zone), data = longer_data)

# Create a new data frame for predictions
new_data <- expand.grid(SEVERITY_CODE = seq(min(longer_data$SEVERITY_CODE), max(longer_data$SEVERITY_CODE), length.out = 100),
                        species = unique(longer_data$species),
                        reef_zone = unique(longer_data$reef_zone))

# Predict observation counts
new_data$predicted_count <- predict(model, newdata = new_data, re.form = NA)

# Plotting
ggplot(new_data, aes(x = SEVERITY_CODE, y = predicted_count, color = species)) +
  geom_line() +
  facet_wrap(~species) +
  labs(title = "Predicted Observation Count vs. Severity Code for Each Species",
       x = "Severity Code",
       y = "Predicted Observation Count") +
  theme_minimal()

```


##Results

##Discussion

##Author Contributions

##References
