---
title: "Coral Reef Health and Organismal Occurrence Analysis Project"
author: "Jonah Kotzen, Elisabeth Laviolette, Lauren Geary, Elizabeth Breitmeyer & Katie Miller"
date: "2023-12-06"
output: html_document
bibliography: BIOL3140.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rgbif)
library(tidyverse)
library(MuMIn)
library(rnoaa)
library(data.table)
library(ggmap)
library(usmap)
library(sf)
library(magick)
library(cowplot)
library(lme4)
library(car)
```

## Introduction
[Provide a brief overview of the project, its objectives, and its significance]

## Objectives
- Objective 1: [Detail the primary objective of your project]
- Objective 2: [Detail the secondary objective of your project, if any]

## Methodology
Briefly describe the methodology used in this project, including data sources and analysis techniques.

### Data Sources
- Coral Reef Health Data: [Describe the source and nature of the coral reef health data]
- Fish Occurrence Data: Using the `rgbif` package to access data from GBIF.

### Data Retrieval and Processing
#### Using `rgbif` for Fish Occurrence Data
```{r querying GBIFs API, echo=FALSE, cache = TRUE}
# Species list
species <- c("Triaenodon obesus", "Tridacna gigas", "Chaetodon rainfordi", 
             "Abudefduf vaigiensis", "Chlorurus undulatus", "Cephalopholis miniata", 
             "Chlorurus sordidus")

# Time range
year_range <- "2000,2023"

# Create an empty list to store the data
data_list <- list()

# Loop over the species list and retrieve data for each species
for (sp in species) {
  data_list[[sp]] <- occ_search(scientificName = sp, country = "AU", year = year_range, limit = 300)
}

library(dplyr)
library(purrr)

# Process each data frame to select specific columns and add a species column, handle NULL values
processed_data_list <- map(data_list, ~ {
  if (is.null(.x$data)) {
    return(NULL)
  } else {
    .x$data %>%
      select(species = scientificName, 
             decimalLatitude, 
             decimalLongitude, 
             year, 
             speciesKey, 
             dateIdentified, 
             coordinateUncertaintyInMeters)
  }
})

# Remove NULL elements
processed_data_list <- processed_data_list[!sapply(processed_data_list, is.null)]

# Combine all the data frames into one tibble
combined_data <- bind_rows(processed_data_list)

species_counts <- combined_data %>%
  count(species)
```


```{r coral bleaching data, echo=FALSE, cache = TRUE}
bleachingdata <- read_csv("bleachingdatabase.csv")
head(bleachingdata)
```

```{r modbleach, include=TRUE}
filtered_data <- bleachingdata %>%
  select(LATITUDE, LONGITUDE, YEAR, SEVERITY_CODE, LOCATION) %>%
  filter(complete.cases(.))
```

```{r reef stuff, include=TRUE}

# Define the latitude and longitude boundaries of the Great Barrier Reef
lat_min <- -24   # Southernmost latitude
lat_max <- -11   # Northernmost latitude
long_min <- 142  # Westernmost longitude
long_max <- 154  # Easternmost longitude

# Add the within_reef column
filtered_data <- filtered_data %>%
  mutate(within_reef = LATITUDE >= lat_min & LATITUDE <= lat_max & 
                        LONGITUDE >= long_min & LONGITUDE <= long_max)


# Group by the within_reef column and count the number of TRUE and FALSE values
reef_count <- filtered_data %>%
  group_by(within_reef) %>%
  summarise(count = n())

# The reef_count tibble now contains the count of TRUE and FALSE values in the within_reef column.

reef_data <- filtered_data %>%
  filter(within_reef == TRUE)

```

```{r zone grouping, include=TRUE}
# Determine new latitude boundaries for each zone based on quantiles
zone_boundary_1 <- quantile(reef_data$LATITUDE, probs = 1/3)
zone_boundary_2 <- quantile(reef_data$LATITUDE, probs = 2/3)

# Re-assign the reef_zone column
reef_data <- reef_data %>%
  mutate(reef_zone = case_when(
    LATITUDE <= zone_boundary_1 ~ "A",
    LATITUDE > zone_boundary_1 & LATITUDE <= zone_boundary_2 ~ "B",
    TRUE ~ "C"
  ))

# Check the new distribution
new_zone_counts <- reef_data %>%
  count(reef_zone)

```


```{r visualizing, include=TRUE}
library(ggplot2)
library(dplyr)
library(leaflet)

# Create a leaflet map and add tiles
reef_map <- leaflet() %>% 
  addTiles() %>%  # This adds the default OpenStreetMap tiles
  setView(lng = mean(c(142, 154)), lat = mean(c(-24, -10)), zoom = 6)

# Add points to the map
reef_map <- reef_map %>% 
  addCircleMarkers(data = reef_data, 
                   ~LONGITUDE, 
                   ~LATITUDE, 
                   color = ~case_when(reef_zone == "A" ~ "green",
                                      reef_zone == "B" ~ "orange",
                                      reef_zone == "C" ~ "red"),
                   popup = ~paste("Zone:", reef_zone))

# Print the map
reef_map

```

```{r severity, include=TRUE}
# Calculate the range of SEVERITY_CODE values for each year
severity_code_range <- reef_data %>%
  group_by(YEAR) %>%
  summarise(
    min_severity = min(SEVERITY_CODE, na.rm = TRUE),
    max_severity = max(SEVERITY_CODE, na.rm = TRUE)
  )

# View the resulting tibble
print(severity_code_range)

library(ggplot2)

# Plotting the range of severity codes for each year
ggplot(severity_code_range, aes(x = YEAR)) +
  geom_bar(aes(y = max_severity), stat = "identity", position = "dodge", fill = "steelblue") +
  geom_bar(aes(y = min_severity), stat = "identity", position = "dodge", fill = "firebrick") +
  theme_minimal() +
  labs(title = "Range of Severity Codes Over the Years",
       x = "Year",
       y = "Severity Code",
       fill = "Severity") +
  scale_fill_manual(values = c("Max Severity" = "steelblue", "Min Severity" = "firebrick")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for better readability



```


```{r zoning species, include=TRUE}
# Assuming zone_boundary_1 and zone_boundary_2 are already defined
# and combined_data has decimalLatitude and decimalLongitude columns

# Add the reef_zone column to combined_data
combined_data <- combined_data %>%
  mutate(reef_zone = case_when(
    decimalLatitude <= zone_boundary_1 ~ "A",
    decimalLatitude > zone_boundary_1 & decimalLatitude <= zone_boundary_2 ~ "B",
    decimalLatitude > zone_boundary_2 ~ "C"
  ))

# Now, combined_data contains the new column reef_zone with values A, B, or C
```

```{r count, include=TRUE}
# Count the number of unique species in each reef zone
species_observations_per_zone_year <- combined_data %>%
  filter(!is.na(reef_zone)) %>%
  group_by(reef_zone, species, year) %>%
  summarise(observation_count = n(), .groups = "drop")

```

```{r plots, include=TRUE}
library(ggplot2)

# Plot observation_count vs. year for each species, facetted by species
ggplot(species_observations_per_zone_year, aes(x = year, y = observation_count, group = reef_zone, color = reef_zone)) +
  geom_line() + 
  geom_point() +  # Add points to the lines
  facet_wrap(~ species, scales = "free_y") +  # Facet by species, with free y scales for each plot
  theme_minimal() + 
  labs(title = "Observation Count vs. Year for Each Species by Reef Zone",
       x = "Year",
       y = "Observation Count",
       color = "Reef Zone") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))  # Rotate x-axis labels for better readability



```

```{r plot 2, include=TRUE}
# Plot observation_count vs. year, separated by reef_zone
ggplot(species_observations_per_zone_year, aes(x = year, y = observation_count, color = species)) +
  geom_line(aes(group = species)) + 
  geom_point(aes(shape = species)) +  # Add points to the lines
  facet_grid(. ~ reef_zone) +  # Create a separate graph for each reef zone
  theme_minimal() + 
  labs(title = "Observation Count vs. Year by Reef Zone",
       x = "Year",
       y = "Observation Count",
       color = "Species",
       shape = "Species") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),  # Rotate x-axis labels for better readability
        legend.position = "bottom") +  # Move legend to bottom
  guides(color = guide_legend(override.aes = list(shape = NA)))  # Remove shapes from color legend
```

```{r merging, eval=FALSE, include=TRUE}
### HOLD OFF ON THIS ####

joined_data <- combined_data %>%
  left_join(reef_data, by = "reef_zone")

```

##Results

##Discussion

##Author Contributions

##References
